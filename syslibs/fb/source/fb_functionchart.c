
/******************************************************************************
 *
 *   FILE
 *   ----
 *   functionchart.c
 *
 *   History
 *   -------
 *   2011-06-10   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'fb_builder' command
 *
 ******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_fb
#define OV_COMPILE_LIBRARY_fb
#endif


#include "fb.h"
#include "ov_macros.h"
#include "fb_namedef.h"
#include "fb_macros.h"
#include "fb_log.h"
#include "ov_call_macros_10.h"


OV_DLLFNCEXPORT void fb_functionchart_execute(
	OV_INSTPTR_fb_task	ptask,
	OV_TIME				*pltc
) {
	/*
	*	local variables
	*/
	char						help[128];
	OV_TIME						t0;
	OV_TIME						t1;
	OV_BOOL						ret;
	OV_INSTPTR_fb_functionchart	pinst = Ov_StaticPtrCast(fb_functionchart, ptask);


	/*
	*	is otc >= ltc or function off?
	*/
	if((ov_time_compare(&pinst->v_proctime, pltc) == OV_TIMECMP_AFTER) || (pinst->v_actimode == FB_AM_OFF)) {
		return;
	}

	/* Logging */
	FbSvcLog_incrIndent();
	sprintf(help, "executing (method counter %" OV_PRINT_UINT ")", pinst->v_methcount);
	FbSvcLog_printexecitem((OV_INSTPTR_ov_object)pinst, help);

	/* trigger input get connections */
	fb_object_triggerInpGetConnections(Ov_PtrUpCast(fb_object, pinst));

	/* test if we need to calculate new outputs */
	ov_time_gettime(&t0);
	if(pinst->v_iexreq || pinst->v_eexreq) {

		/* call typemethod and supervise if appropriate */
		ret = fb_functionblock_execTypeMethod(Ov_PtrUpCast(fb_functionblock, pinst), pltc);

		/* Typemethod ausgefuehrt? */
		if(ret == FALSE) {
			/* Logging */
			FbSvcLog_decrIndent();
			return;
		}
	}

	/* execute the child objects */
	fb_task_execChildObjects(ptask, pltc);

	/* trigger output send connections */
	fb_object_triggerOutSendConnections(Ov_PtrUpCast(fb_object, pinst));

	/* calculate new value of otc */
	fb_task_setNextProcTime(ptask, pltc);

	/* calctime */
	ov_time_gettime(&t1);
	ov_time_diff(&pinst->v_calctime, &t1, &t0);

	/* Logging */
	FbSvcLog_decrIndent();

	return;
}


OV_DLLFNCEXPORT OV_RESULT fb_functionchart_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    OV_INSTPTR_fb_functionchart pinst = Ov_StaticPtrCast(fb_functionchart, pobj);
    OV_RESULT    result;

    /* do what the base class does first */
    result = fb_functionblock_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    return Ov_Link(fb_tasklist, pinst, &pinst->p_intask);
}


/*
 *	Typemethod of functionchart
 */
OV_DLLFNCEXPORT void fb_functionchart_typemethod(
		OV_INSTPTR_fb_functionblock  pfb,
		OV_TIME                     *pltc
) {
	OV_INSTPTR_fb_functionchart pfc = Ov_StaticPtrCast(fb_functionchart, pfb);
	OV_INSTPTR_fb_task          intask = Ov_GetPartPtr(intask, pfc);
	OV_INSTPTR_fb_task			parentTask = Ov_GetParent(fb_tasklist, intask);

	/* Init intask */
	intask->v_actimode = FB_AM_ON;
	intask->v_cyctime.secs = 0;
	intask->v_cyctime.usecs = 0;
	intask->v_proctime = *pltc;

	if(!parentTask){
		Ov_Link(fb_tasklist, pfc, intask);
	} else if((OV_INSTPTR)parentTask!=(OV_INSTPTR)pfc){
		Ov_Unlink(fb_tasklist, parentTask, intask);
		Ov_Link(fb_tasklist, pfc, intask);
	}

}

/**
 * Searches for a port of an FC by port's name
 *
 * @param pfc pointer to the FC
 * @param id of port to search
 * @return pointer to the found port of NULL
 */
static OV_INSTPTR_fb_port fb_functionchart_searchport
(OV_INSTPTR_fb_functionchart pfc,
		OV_STRING id
)
{
	OV_INSTPTR_fb_port pvar;

	Ov_ForEachChild (fb_variables, pfc, pvar)
	{
		if (ov_string_compare (id, pvar->v_identifier) == OV_STRCMP_EQUAL)
		{
			return pvar;
		}
	}

	return NULL;
}

/**
 * Auxiliary static function for fb_functionchart_setport and _getport
 *
 * @param pfc pointer to the FC
 * @param varname name of the port to get/set
 * @param pvarcurrprops value to get/set
 * @return standard error code
 */
static OV_RESULT fb_functionchart_getorsetport
(OV_INSTPTR_fb_functionchart pfc,
		const OV_STRING varname,
		OV_ANY *pvarcurrprops,
		OV_BOOL getorset)
{
	OV_ELEMENT objelem, varelem;
	OV_INSTPTR_fb_port pvar;
	OV_STRING varid;


	if ((pvar = fb_functionchart_searchport(pfc, varname))) {
		objelem.pobj = Ov_PtrUpCast (ov_object, pvar);
		varid = "value";
	} else {
		objelem.pobj = Ov_PtrUpCast (ov_object, pfc);
		varid = varname;
	}
	objelem.elemtype = OV_ET_OBJECT;
	if (Ov_OK(ov_element_searchpart(&objelem, &varelem, OV_ET_VARIABLE, varid)) && varelem.pobj!=NULL) {
		if (getorset) {
			return Ov_Call2 (ov_object, objelem.pobj, getvar, &varelem, pvarcurrprops);
		} else {
			return Ov_Call2 (ov_object, objelem.pobj, setvar, &varelem, pvarcurrprops);
		}
	}else{
		return OV_ERR_BADPARAM;
	}
}

/**
 * Sets dynamic port of an FC or its internal variable if port not found
 *
 * @param pfc pointer to the FC
 * @param varname name of the port to set
 * @param pvarcurrprops value to set
 * @return standard error code
 */
OV_DLLFNCEXPORT OV_RESULT fb_functionchart_setport(
		OV_INSTPTR_fb_functionchart     pfc,
		const OV_STRING varname,
		OV_ANY *pvarcurrprops
) {
	return fb_functionchart_getorsetport(pfc, varname, pvarcurrprops, FALSE);
}

/**
 * Gets dynamic port of an FC or its internal variable if port not found
 *
 * @param pfc pointer to the FC
 * @param varname name of the port to set
 * @param pvarcurrprops value to save the value
 * @return standard error code
 */
OV_DLLFNCEXPORT OV_RESULT fb_functionchart_getport(
		OV_INSTPTR_fb_functionchart     pfc,
		const OV_STRING varname,
		OV_ANY *pvarcurrprops
) {
	return fb_functionchart_getorsetport(pfc, varname, pvarcurrprops, TRUE);
}
